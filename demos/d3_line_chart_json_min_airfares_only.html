<!-- Code from d3-graph-gallery.com -->
<!DOCTYPE html>
<meta charset="utf-8">

<!-- Load d3.js -->
<script src="https://d3js.org/d3.v4.js"></script>
<!-- Custom CSS -->
<link rel="stylesheet" type="text/css" href="css/custom.css">
<!-- Vector icons and social logos | https://fontawesome.com/icons?d=gallery&m=free -->
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.1/css/all.min.css">


<style>
    div.tooltip {
        position: absolute;
        text-align: center;
        width: 130px;
        height: 60px;
        padding: 2px;
        /*font: 12px;*/
        font-size: 0.7em;
        background: #333;
        color: white;
        border: 0px;
        border-radius: 8px;
        pointer-events: none;
    }
    
    body {
        background-color: white;
        color: black;
    }
    
    .annotation-line {
        stroke: #000;
        stroke-opacity: 0.15;
        stroke-width: 1px;
        pointer-events: none;
    }
    
    .g-text-annotation {
        font-size: 11px;
        font-family: Arial;
        fill: #999;
        text-anchor: middle;
        pointer-events: none;
    }
</style>

<!-- Create a div where the graph will take place -->
<div id="my_dataviz" style="position: relative">
    <div id="legends" style="position: absolute; top:0; right:0em">
        <i class="fas fa-circle" style="color: orange"></i>&nbsp;&nbsp;Sydney&nbsp;&nbsp;<i class="fas fa-exchange-alt"></i>&nbsp;&nbsp;Auckland
        <br/>
        <i class="fas fa-circle" style="color: #DB4437"></i>&nbsp;&nbsp;Sydney&nbsp;&nbsp;<i class="fas fa-exchange-alt"></i>&nbsp;&nbsp;Zurich
        <br/>
        <i class="fas fa-circle" style="color: #795548"></i>&nbsp;&nbsp;Sydney&nbsp;&nbsp;<i class="fas fa-exchange-alt"></i>&nbsp;&nbsp;Vancouver
        <br/>
        <i class="fas fa-circle" style="color: #4285F4"></i>&nbsp;&nbsp;Sydney&nbsp;&nbsp;<i class="fas fa-exchange-alt"></i>&nbsp;&nbsp;Nadi
        <br/>
        <i class="fas fa-circle" style="color:pink"></i>&nbsp;&nbsp;Sydney&nbsp;&nbsp;<i class="fas fa-exchange-alt"></i>&nbsp;&nbsp;Darwin
        <br/>
        <i class="fas fa-circle" style="color:#ccc"></i>&nbsp;&nbsp;Sydney&nbsp;&nbsp;<i class="fas fa-exchange-alt"></i>&nbsp;&nbsp;Apia
        <br/>
        <i class="fas fa-circle" style="color:#FFFF00"></i>&nbsp;&nbsp;Sydney&nbsp;&nbsp;<i class="fas fa-exchange-alt"></i>&nbsp;&nbsp;Port Vila
        <br/>
        <i class="fas fa-circle" style="color:#4CAF50"></i>&nbsp;&nbsp;Sydney&nbsp;&nbsp;<i class="fas fa-exchange-alt"></i>&nbsp;&nbsp;Adelaide

    </div>

    <!--<svg id="legends" style="position: absolute; top:0; right:0">
    </svg>-->
</div>

<script>
    // select the svg area
    var svgLegends = d3.select("#legends")

    // Handmade legend
    /*svgLegends.append('mytext')
    svgLegends.append("circle").attr("cx", 100).attr("cy", 30).attr("r", 6).style("fill", "orange").style("stroke", "black")
    svgLegends.append("circle").attr("cx", 100).attr("cy", 60).attr("r", 6).style("fill", "red").style("stroke", "black")
    svgLegends.append("text").attr("x", 120).attr("y", 30).text("Sydney - Auckland").style("font-size", "15px").attr("alignment-baseline", "middle").style("stroke", "black")
    svgLegends.append("text").attr("x", 120).attr("y", 60).text("Sydney - Zurich").style("font-size", "15px").attr("alignment-baseline", "middle").style("stroke", "black")*/




    // set the dimensions and margins of the graph
    var margin = {
            top: 10,
            right: 30,
            bottom: 30,
            left: 60
        },
        width = 1400 - margin.left - margin.right,
        height = 600 - margin.top - margin.bottom;


    // Define the div for the tooltip
    var div = d3.select("body").append("div")
        .attr("class", "tooltip")
        .style("opacity", 0);

    // append the svg object to the body of the page
    var svg = d3.select("#my_dataviz")
        .append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform",
            "translate(" + margin.left + "," + margin.top + ")");









    //Read the data
    d3.json("data/airfares.json", function(data) {


        // Transforming the JSON file to answer our needs (looking for the smallest fare for a specific timestamp/period)
        //http://learnjsdata.com/group_data.html
        var minimumAirfaresBySearchedTimestamp = d3.nest()
            .key(function(d) {
                return d.searched_on;
            })
            .rollup(function(v) {
                return d3.min(v, function(d) {
                    return d; // return d.price -- would return only the airfare, d return the whole dataset
                });
            })
            .entries(data);
        console.log(JSON.stringify(minimumAirfaresBySearchedTimestamp));





        // Grouping Data by search date in order to isolate the min/max airfare | http://learnjsdata.com/group_data.html
        /*var airfaresBySearchedOn = d3.nest()
            .key(function(d) {
                return d.searched_on;
            })
            .entries(data);*/

        //console.log(JSON.stringify(airfaresBySearchedOn));



        // D3 | finding max value for searched_on in a JSON array of objects
        var maxSearchedOnTimestamp = d3.max([
            d3.max(minimumAirfaresBySearchedTimestamp, function(d) {
                return d.value.searched_on;
            })
        ]);

        // D3 | finding min value for searched_on on in a JSON array of objects
        var minSearchedOnTimestamp = d3.min([
            d3.min(minimumAirfaresBySearchedTimestamp, function(d) {
                return d.value.searched_on;
            })
        ]);

        // D3 | finding max value for price in a JSON array of objects
        var maxPrice = d3.max([
            d3.max(minimumAirfaresBySearchedTimestamp, function(d) {
                return parseInt(d.value.price);
            })
        ]);

        // D3 | finding min value for price on in a JSON array of objects
        var minPrice = d3.min([
            d3.min(minimumAirfaresBySearchedTimestamp, function(d) {
                return parseInt(d.value.price);
            })
        ]);


        // Add X axis
        var x = d3.scaleTime()
            .domain([new Date(minSearchedOnTimestamp), new Date(maxSearchedOnTimestamp)]) //    new Date(2020, 6, 31)[4, 8]   max(new Date(d.searched_on))
            .range([0, width]);
        svg.append("g")
            .attr("transform", "translate(0," + height + ")")
            .call(d3.axisBottom(x)
                //.ticks(25)
            );

        // Add Y axis
        var y = d3.scaleLinear()
            .domain([0, maxPrice])
            .range([height, 0]);
        svg.append("g")
            .call(d3.axisLeft(y));

        // Color scale: give me a specie name, I return a color
        var color = d3.scaleOrdinal()
            .domain(["Apia", "Darwin", "Zurich", "Geneva", "Auckland", "Nadi", "Port Vila", "Vancouver", "Adelaide"])
            .range(["#ccc", "pink", "#DB4437", "red", "orange", "#4285F4", "#FFFF00", "#795548", "#4CAF50"])


        // Highlight the specie that is hovered
        /*var highlight = function(d) {

            selected_destination = d.destination

            d3.selectAll(".dot")
                .transition()
                .duration(200)
                .style("fill", "lightgrey")
                .attr("r", 3)

            d3.selectAll("." + selected_destination)
                .transition()
                .duration(200)
                .style("fill", color(selected_destination))
                .attr("r", 5)
        }*/


        // Highlight the specie that is hovered
        /*var doNotHighlight = function() {
            d3.selectAll(".dot")
                .transition()
                .duration(200)
                .style("fill", "lightgrey")
                .attr("r", 3)
        }*/

        // Add dots
        svg.append('g')
            .selectAll("dot")
            .data(minimumAirfaresBySearchedTimestamp)
            .enter()
            .filter(function(d) { // how to use the .filter statement directly in the .data statement
                return parseInt(d.value.price) < 2500
            })
            .append("circle")
            .attr("class", function(d) {
                return "dot " + d.value.destination
            })
            .attr("cx", function(d) {
                var searchedOnVar = '';
                var airfair = '';
                return x(new Date(d.value.searched_on));
            })
            .attr("cy", function(d) {
                return y(d.value.price);
            })
            .attr("r", 3)
            .style("stroke", function(d) {
                return '#333'
            })
            .style("fill", function(d) {
                return color(d.value.destination)
            })
            .on("mouseover", function(d) {
                div.transition()
                    .duration(200)
                    .style("opacity", .9);
                div.html(d.value.departure + " to " + d.value.destination + "<br/>" + d.value.searched_on + " (UTC)<br/>$" + d.value.price)
                    .style("left", (d3.event.pageX) + "px")
                    .style("top", (d3.event.pageY - 28) + "px");
            })
            .on("mouseout", function(d) {
                div.transition()
                    .duration(500)
                    .style("opacity", 0);
            })
            /*.on("mouseover", highlight)
            .on("mouseleave", doNotHighlight)*/

        // Add annotation



        svg.append("text")
            .attr("x", function(d) {
                return x(new Date('2020-09-24 14:21:55'));
            })
            .attr("y", function(d) {
                return y(60);
            })
            .text("South Australia opens border to NSW")
            .attr("class", "g-text-annotation")

        svg.append("line")
            .attr("x1", function(d) {
                return x(new Date('2020-09-24 14:21:55'));
            })
            .attr("x2", function(d) {
                return x(new Date('2020-09-24 14:21:55'));
            })
            .attr("y1", function(d) {
                return y(80);
            })
            .attr("y2", function(d) {
                return y(240);
            })
            .attr("class", "annotation-line")







        svg.append("text")
            .attr("x", function(d) {
                return x(new Date('2020-11-20 14:21:55'));
            })
            .attr("y", function(d) {
                return y(300);
            })
            .text("National Cabinet has agreed to reopen all but")
            .attr("class", "g-text-annotation")

        svg.append("text")
            .attr("x", function(d) {
                return x(new Date('2020-11-13 14:21:55'));
            })
            .attr("y", function(d) {
                return y(280);
            })
            .text("one state border before Christmas")
            .attr("class", "g-text-annotation")

        svg.append("line")
            .attr("x1", function(d) {
                return x(new Date('2020-11-13 14:21:55'));
            })
            .attr("x2", function(d) {
                return x(new Date('2020-11-13 14:21:55'));
            })
            .attr("y1", function(d) {
                return y(300);
            })
            .attr("y2", function(d) {
                return y(440);
            })
            .attr("class", "annotation-line")







        svg.append("text")
            .attr("x", function(d) {
                return x(new Date('2020-11-16 14:21:55'));
            })
            .attr("y", function(d) {
                return y(180);
            })
            .text("South Australia Imposes Six-Day Lockdown")
            .attr("class", "g-text-annotation")

        svg.append("line")
            .attr("x1", function(d) {
                return x(new Date('2020-11-16 14:21:55'));
            })
            .attr("x2", function(d) {
                return x(new Date('2020-11-16 14:21:55'));
            })
            .attr("y1", function(d) {
                return y(200);
            })
            .attr("y2", function(d) {
                return y(400);
            })
            .attr("class", "annotation-line")




        svg.append("text")
            .attr("x", function(d) {
                return x(new Date('2020-11-20 14:21:55'));
            })
            .attr("y", function(d) {
                return y(80);
            })
            .text("South Australia to end lockdown early,")
            .attr("class", "g-text-annotation")

        svg.append("text")
            .attr("x", function(d) {
                return x(new Date('2020-11-20 14:21:55'));
            })
            .attr("y", function(d) {
                return y(60);
            })
            .text("after pizza parlour blunder")
            .attr("class", "g-text-annotation")

        svg.append("line")
            .attr("x1", function(d) {
                return x(new Date('2020-11-20 14:21:55'));
            })
            .attr("x2", function(d) {
                return x(new Date('2020-11-20 14:21:55'));
            })
            .attr("y1", function(d) {
                return y(100);
            })
            .attr("y2", function(d) {
                return y(350);
            })
            .attr("class", "annotation-line")

    })
</script>