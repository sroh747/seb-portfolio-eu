<!-- Code from d3-graph-gallery.com -->
<!DOCTYPE html>
<meta charset="utf-8">

<!-- Load d3.js -->
<script src="https://d3js.org/d3.v4.js"></script>
<!-- Custom CSS -->
<link rel="stylesheet" type="text/css" href="css/custom.css">
<!-- Vector icons and social logos | https://fontawesome.com/icons?d=gallery&m=free -->
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.1/css/all.min.css">


<style>
    div.tooltip {
        position: absolute;
        text-align: center;
        width: 130px;
        height: 70px;
        padding: 2px;
        /*font: 12px;*/
        font-size: 0.7em;
        background: #333;
        color: white;
        border: 0px;
        border-radius: 8px;
        pointer-events: none;
    }
    
    body {
        background-color: white;
        color: black;
    }
    
    .dotted-horizontal-line {
        stroke: #333;
        stroke-opacity: 0.20;
        stroke-width: 1px;
        stroke-dasharray: 3, 3;
        pointer-events: none;
    }
    
    .annotation-line {
        stroke: #000;
        stroke-opacity: 0.3;
        stroke-width: 1px;
        pointer-events: none;
    }
    
    .g-text-annotation {
        font-size: 11px;
        font-family: Arial;
        fill: #999;
        text-anchor: middle;
        pointer-events: none;
    }
</style>

<!-- Create a div where the graph will take place -->
<div id="my_dataviz" style="position: relative">
    <div id="legends" style="position: absolute; top:0; right:0em">
        AIRFARES TRACKER
        <br/><br/>
        <i class="fas fa-circle" style="color:#4CAF50"></i>&nbsp;&nbsp;Sydney&nbsp;&nbsp;<i class="fas fa-exchange-alt"></i>&nbsp;&nbsp;Adelaide
        <br/>
        Outbound flight: 2020-12-20
        <br/>
        Inbound flight: 2020-12-29
    </div>

    <!--<svg id="legends" style="position: absolute; top:0; right:0">
    </svg>-->


</div>

<script>
    // select the svg area
    var svgLegends = d3.select("#legends")

    // Handmade legend
    /*svgLegends.append('mytext')
    svgLegends.append("circle").attr("cx", 100).attr("cy", 30).attr("r", 6).style("fill", "orange").style("stroke", "black")
    svgLegends.append("circle").attr("cx", 100).attr("cy", 60).attr("r", 6).style("fill", "red").style("stroke", "black")
    svgLegends.append("text").attr("x", 120).attr("y", 30).text("Sydney - Auckland").style("font-size", "15px").attr("alignment-baseline", "middle").style("stroke", "black")
    svgLegends.append("text").attr("x", 120).attr("y", 60).text("Sydney - Zurich").style("font-size", "15px").attr("alignment-baseline", "middle").style("stroke", "black")*/




    // set the dimensions and margins of the graph
    var margin = {
            top: 20,
            right: 30,
            bottom: 20,
            left: 50
        },
        width = 1400 - margin.left - margin.right,
        height = 700 - margin.top - margin.bottom;


    // Define the div for the tooltip
    var div = d3.select("body").append("div")
        .attr("class", "tooltip")
        .style("opacity", 0);

    // append the svg object to the body of the page
    var svg = d3.select("#my_dataviz")
        .append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform",
            "translate(" + margin.left + "," + margin.top + ")");



    //Read the data
    d3.json("data/airfaresSydneyAdelaide.json", function(data) {

        // Generate a new JSON, filtering out all destinations except the one we want to display
        /*var result = []

        for (var index in data) {
            if (data[index]['destination'] === 'Adelaide') {
                var jsonData = {}
                jsonData['id'] = data[index]['id'];
                jsonData['departure'] = data[index]['departure'];
                jsonData['destination'] = data[index]['destination'];
                jsonData['departure_date'] = data[index]['departure_date'];
                jsonData['arrival_date'] = data[index]['arrival_date'];
                jsonData['flightJourney'] = data[index]['flightJourney'];
                jsonData['price'] = data[index]['price'];
                jsonData['provider'] = data[index]['provider'];
                jsonData['searched_on'] = data[index]['searched_on'];
                result.push(jsonData);
            }
        }
        data = result;*/



        // D3 | finding max value for searched_on in a JSON array of objects
        var maxSearchedOnTimestamp = d3.max([
            d3.max(data, function(d) {
                return d.searched_on;
            })
        ]);

        // D3 | finding min value for searched_on on in a JSON array of objects
        var minSearchedOnTimestamp = d3.min([
            d3.min(data, function(d) {
                return d.searched_on;
            })
        ]);
        

        // D3 | finding max value for price in a JSON array of objects
        var maxPrice = d3.max([
            d3.max(data, function(d) {
                return d.price;
            })
        ]);

        //alert(maxPrice)
        maxPrice = 1000

        // D3 | finding min value for price on in a JSON array of objects
        var minPrice = d3.min([
            d3.min(data, function(d) {
                return d.price;
            })
        ]);


        //alert(maxSearchedOnTimestamp.substr(0, 10))


        // Add X axis
        var x = d3.scaleTime()
            .domain([new Date(minSearchedOnTimestamp), new Date(maxSearchedOnTimestamp)]) //    new Date(2020, 6, 31)[4, 8]   max(new Date(d.searched_on))
            .range([0, width]);
        svg.append("g")
            .attr("transform", "translate(0," + height + ")")
            .call(d3.axisBottom(x)
                .ticks(10)
            );

        // Add Y axis
        var y = d3.scaleLinear()
            .domain([0, maxPrice])
            .range([height, 0]);
        svg.append("g")
            .call(d3.axisLeft(y));

        // Color scale: give me a dot name, I return a color
        var color = d3.scaleOrdinal()
            .domain(["Apia", "Darwin", "Zurich", "Geneva", "Auckland", "Nadi", "Port Vila", "Vancouver", "Adelaide"])
            .range(["#ccc", "pink", "#DB4437", "red", "orange", "#4285F4", "#FFFF00", "#795548", "#4CAF50"])


        // Highlight the dot that is hovered
        var highlight = function(d) {

            selected_destination = d.destination

            d3.selectAll(".dot")
                .transition()
                .duration(200)
                .style("fill", "lightgrey")
                .attr("r", 3)

            d3.selectAll("." + selected_destination)
                .transition()
                .duration(200)
                .style("fill", color(selected_destination))
                .attr("r", 5)
        }

        // Highlight the dot that is hovered
        var doNotHighlight = function() {
            d3.selectAll(".dot")
                .transition()
                .duration(200)
                .style("fill", "lightgrey")
                .attr("r", 3)
        }

        // Add dots
        svg.append('g')
            .selectAll("dot")
            .data(data)
            .enter()
            .append("circle")
            .attr("class", function(d) {
                return "dot " + d.destination
            })
            .attr("cx", function(d) {
                return x(new Date(d.searched_on));
            })
            .attr("cy", function(d) {
                return y(d.price);
            })
            .attr("r", 3)
            .style("stroke", function(d) {
                return '#333'
            })
            .style("fill", function(d) {
                return color(d.destination)
            })
            .on("mouseover", function(d) {
                div.transition()
                    .duration(200)
                    .style("opacity", .9);
                div.html(d.departure + " to " + d.destination + "<br/>" + d.provider + "<br/>" + d.searched_on + " (UTC)<br/>$" + d.price)
                    .style("left", (d3.event.pageX) + "px")
                    .style("top", (d3.event.pageY - 28) + "px");
            })
            .on("mouseout", function(d) {
                div.transition()
                    .duration(500)
                    .style("opacity", 0);
            })
            /*.on("mouseover", highlight)
            .on("mouseleave", doNotHighlight)*/



        // Add annotations

        svg.append("text")
            .attr("x", function(d) {
                return x(new Date('2020-09-24 14:21:55'));
            })
            .attr("y", function(d) {
                return y(80);
            })
            .text("South Australia opens")
            .attr("class", "g-text-annotation")


        svg.append("text")
            .attr("x", function(d) {
                return x(new Date('2020-09-24 14:21:55'));
            })
            .attr("y", function(d) {
                return y(60);
            })
            .text("border to NSW")
            .attr("class", "g-text-annotation")


        svg.append("line")
            .attr("x1", function(d) {
                return x(new Date('2020-09-24 14:21:55'));
            })
            .attr("x2", function(d) {
                return x(new Date('2020-09-24 14:21:55'));
            })
            .attr("y1", function(d) {
                return y(80);
            })
            .attr("y2", function(d) {
                return y(240);
            })
            .attr("class", "annotation-line")







        svg.append("text")
            .attr("x", function(d) {
                return x(new Date('2020-11-13 14:21:55'));
            })
            .attr("y", function(d) {
                return y(300);
            })
            .text("National Cabinet has agreed to reopen all but")
            .attr("class", "g-text-annotation")

        svg.append("text")
            .attr("x", function(d) {
                return x(new Date('2020-11-13 14:21:55'));
            })
            .attr("y", function(d) {
                return y(280);
            })
            .text("one state border before Christmas")
            .attr("class", "g-text-annotation")

        svg.append("line")
            .attr("x1", function(d) {
                return x(new Date('2020-11-13 14:21:55'));
            })
            .attr("x2", function(d) {
                return x(new Date('2020-11-13 14:21:55'));
            })
            .attr("y1", function(d) {
                return y(300);
            })
            .attr("y2", function(d) {
                return y(440);
            })
            .attr("class", "annotation-line")







        svg.append("text")
            .attr("x", function(d) {
                return x(new Date('2020-11-16 14:21:55'));
            })
            .attr("y", function(d) {
                return y(180);
            })
            .text("South Australia Imposes Six-Day Lockdown")
            .attr("class", "g-text-annotation")

        svg.append("line")
            .attr("x1", function(d) {
                return x(new Date('2020-11-16 14:21:55'));
            })
            .attr("x2", function(d) {
                return x(new Date('2020-11-16 14:21:55'));
            })
            .attr("y1", function(d) {
                return y(200);
            })
            .attr("y2", function(d) {
                return y(400);
            })
            .attr("class", "annotation-line")


        svg.append("text")
            .attr("x", function(d) {
                return x(new Date('2020-11-20 14:21:55'));
            })
            .attr("y", function(d) {
                return y(80);
            })
            .text("South Australia to end lockdown early,")
            .attr("class", "g-text-annotation")


        svg.append("text")
            .attr("x", function(d) {
                return x(new Date('2020-11-20 14:21:55'));
            })
            .attr("y", function(d) {
                return y(60);
            })
            .text("after pizza parlour blunder")
            .attr("class", "g-text-annotation")

        svg.append("line")
            .attr("x1", function(d) {
                return x(new Date('2020-11-20 14:21:55'));
            })
            .attr("x2", function(d) {
                return x(new Date('2020-11-20 14:21:55'));
            })
            .attr("y1", function(d) {
                return y(100);
            })
            .attr("y2", function(d) {
                return y(350);
            })
            .attr("class", "annotation-line")



            // Draw dotted horizontal lines (one each $100 up to $2000)
            i=100
            while (i <= 3000) {                
                svg.append("line")
                    .attr("x1", function(d) {
                        return x(new Date(minSearchedOnTimestamp));
                    })
                    .attr("x2", function(d) {
                        return x(new Date(maxSearchedOnTimestamp));
                    })
                    .attr("y1", function(d) {
                        return y(i);
                    })
                    .attr("y2", function(d) {
                        return y(i);
                    })
                    .attr("class", "dotted-horizontal-line")
                
                i = i+100;
            }
            

    })
</script>